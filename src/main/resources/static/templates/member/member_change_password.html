<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>비밀번호 변경</title>
    <style>
        :root {
            --black: #111;
            --gray: #777;
            --light: #f4f5f7;
            --primary: #111;
            --accent: #3F97F6
        }

        * {
            box-sizing: border-box
        }

        html,
        body {
            margin: 0
        }

        body {
            font-family: system-ui, -apple-system, Segoe UI, Roboto, Pretendard, Apple SD Gothic Neo, Malgun Gothic, Noto Sans KR, sans-serif;
            color: var(--black);
            background: #fff
        }

        .wrap {
            max-width: 760px;
            margin: 48px auto;
            padding: 0 20px
        }

        h1 {
            font-size: 40px;
            letter-spacing: -.02em;
            margin: 0 0 24px;
            text-align: center
        }

        .desc {
            color: #555;
            text-align: center;
            line-height: 1.6;
            margin-bottom: 28px
        }

        .card {
            background: #fff;
            border: 1px solid #e6e6e6;
            padding: 28px 24px
        }

        .row {
            margin-bottom: 18px
        }

        label {
            display: block;
            font-weight: 600;
            margin: 0 0 8px
        }

        .field {
            width: 100%;
            height: 50px;
            padding: 0 14px;
            border: 1px solid #ddd;
            outline: none
        }

        .field:focus {
            border-color: #222;
            box-shadow: 0 0 0 3px rgba(0, 0, 0, .06)
        }

        .helper {
            font-size: 13px;
            color: #888;
            margin-top: 6px
        }

        .actions {
            display: flex;
            gap: 10px;
            margin-top: 24px
        }

        .btn {
            flex: 1 1 0;
            height: 50px;
            border: 1px solid #111;
            background: #111;
            color: #fff;
            font-weight: 700;
            cursor: pointer
        }

        .btn.secondary {
            background: #fff;
            color: #111
        }

        .btn:disabled {
            opacity: .5;
            cursor: not-allowed
        }

        .inline {
            display: flex;
            gap: 10px;
            align-items: center
        }

        .bar {
            height: 1px;
            background: #eee;
            margin: 20px 0
        }

        /* 강도바 */
        #strengthBar {
            height: 6px;
            background: #eee;
            margin-top: 8px;
            position: relative;
            border-radius: 3px;
            overflow: hidden
        }

        #strengthFill {
            height: 100%;
            width: 0%
        }
    </style>
</head>

<script>
    fetch("../main/header.html")
        .then(res => res.text())
        .then(data => {
            document.getElementById("header").innerHTML = data;
            const scripts = document.getElementById("header").querySelectorAll("script");
            scripts.forEach(oldScript => {
                const s = document.createElement("script");
                if (oldScript.src) { s.src = oldScript.src; } else { s.textContent = oldScript.textContent; }
                document.body.appendChild(s);
            });
        });

    fetch("../main/footer.html")
        .then(res => res.text())
        .then(data => { document.getElementById("footer").innerHTML = data; });
</script>

<body>
    <div id="header"></div>

    <div class="wrap">
        <h1>비밀번호 변경</h1>
        <p class="desc">인증을 완료한 계정의 비밀번호를 새로 설정할 수 있습니다.</p>

        <div class="card">
            <section id="resetSection" aria-label="비밀번호 재설정">
                <!-- 아이디 (읽기전용) -->
                <div class="row">
                    <label for="resetUserId">아이디</label>
                    <input id="resetUserId" class="field" type="text" placeholder="아이디" autocomplete="username"
                        readonly>
                    <p id="uidHelp" class="helper">인증이 완료된 아이디입니다.</p>
                </div>

                <!-- 새 비밀번호 -->
                <div class="row">
                    <label for="newPass">새 비밀번호</label>
                    <div class="inline" style="width:100%">
                        <input id="newPass" class="field" type="password" placeholder="새 비밀번호 입력"
                            autocomplete="new-password">
                        <button type="button" id="toggleNewPass" class="btn secondary"
                            style="flex:0 0 auto;width:120px">표시/숨김</button>
                    </div>
                    <p class="helper">8~16자, 공백 없음, 영문/숫자/특수문자 중 2가지 이상 포함</p>
                    <p id="ruleMsg" class="helper" style="color:#c00;display:none"></p>
                    <div id="strengthBar">
                        <div id="strengthFill"></div>
                    </div>
                </div>

                <!-- 새 비밀번호 확인 -->
                <div class="row">
                    <label for="confirmPass">새 비밀번호 확인</label>
                    <div class="inline" style="width:100%">
                        <input id="confirmPass" class="field" type="password" placeholder="새 비밀번호 확인 입력"
                            autocomplete="new-password">
                        <button type="button" id="toggleConfirmPass" class="btn secondary"
                            style="flex:0 0 auto;width:120px">표시/숨김</button>
                    </div>
                    <p id="matchMsg" class="helper" style="color:#c00;display:none"></p>
                </div>

                <div class="actions">
                    <button type="button" class="btn secondary" id="backBtn">이전</button>
                    <button id="submitBtn" type="button" class="btn" disabled>다음</button>
                </div>
            </section>
        </div>
    </div>

    <script>
        const $ = s => document.querySelector(s);

        // 아이디 자동 채움
        (function fillUserId() {
            const u = sessionStorage.getItem('verifiedUserId') || '';
            $('#resetUserId').value = u;
            $('#resetUserId').readOnly = !!u;
        })();

        const newPassInput = $('#newPass');
        const confirmInput = $('#confirmPass');
        const submitBtn = $('#submitBtn');
        const ruleMsg = $('#ruleMsg');
        const matchMsg = $('#matchMsg');
        const strengthFill = $('#strengthFill');

        function passRuleOK(pw) {
            if (!pw) return false;
            if (pw.length < 8 || pw.length > 16) return false;
            if (/\s/.test(pw)) return false;
            const hasAlpha = /[A-Za-z]/.test(pw);
            const hasNum = /[0-9]/.test(pw);
            const hasSpec = /[~`!@#$%^*()\-_=+\[\]{};:'",.<>/?\\|]/.test(pw);
            return [hasAlpha, hasNum, hasSpec].filter(Boolean).length >= 2;
        }
        function strengthScore(pw) {
            let s = 0; if (!pw) return 0;
            if (/[A-Za-z]/.test(pw)) s++;
            if (/[0-9]/.test(pw)) s++;
            if (/[~`!@#$%^*()\-_=+\[\]{};:'",.<>/?\\|]/.test(pw)) s++;
            if (pw.length >= 12) s++;
            return Math.min(s, 3);
        }
        function paintStrength(pw) {
            const w = ['0%', '33%', '66%', '100%'];
            const c = ['transparent', '#f5b7b1', '#f7dc6f', '#a9dfbf'];
            const sc = strengthScore(pw);
            strengthFill.style.width = w[sc];
            strengthFill.style.background = c[sc];
        }
        function validateReset() {
            const ruleOk = passRuleOK(newPassInput.value);
            const matchOk = newPassInput.value && (newPassInput.value === confirmInput.value);

            ruleMsg.style.display = ruleOk ? 'none' : 'block';
            ruleMsg.textContent = ruleOk ? '' : '규칙을 확인해 주세요 (8~16자, 공백없음, 2종 이상 조합).';

            matchMsg.style.display = matchOk ? 'none' : 'block';
            matchMsg.textContent = matchOk ? '' : '비밀번호가 일치하지 않습니다.';

            submitBtn.disabled = !(ruleOk && matchOk);
        }

        [newPassInput, confirmInput].forEach(el => {
            el.addEventListener('input', () => { paintStrength(newPassInput.value); validateReset(); });
        });

        // 표시/숨김 토글
        $('#toggleNewPass').addEventListener('click', () => {
            newPassInput.type = newPassInput.type === 'password' ? 'text' : 'password';
        });
        $('#toggleConfirmPass').addEventListener('click', () => {
            confirmInput.type = confirmInput.type === 'password' ? 'text' : 'password';
        });

        // 이전
        $('#backBtn').addEventListener('click', () => history.back());

        // 다음(저장/호출 지점)
        submitBtn.addEventListener('click', async () => {
            if (submitBtn.disabled) return;
            const payload = {
                userid: $('#resetUserId').value.trim(),
                newPassword: newPassInput.value
            };
            // 실제 연동 예시:
            // await fetch('/api/account/reset-password/complete', {...});
            alert('비밀번호가 변경되었습니다.');
            location.href = '/account/reset-password/done'; // 실제 경로로 교체
        });

        // 초기 표시
        paintStrength('');
        validateReset();
    </script>

    <div id="footer"></div>
</body>

</html>